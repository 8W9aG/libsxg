#!/bin/bash
#
# Builds the libsxg deb packages. The script must be run at the root
# directory of the libsxg source tree. The deb packages will be copied to
# the current directory.
#
# This script is written mainly for CI.

set -ex

readonly SRCDIR="${PWD}"
readonly WORKDIR="$(mktemp -d)"
readonly NAME='libsxg'
readonly VERSION='0.1'
readonly TARNAME="${NAME}-${VERSION}"
readonly TARGET_NAME='libsxg-dev'
readonly ARCHITECTURE="$(dpkg --print-architecture)"

echo "Working in ${WORKDIR}"

git archive --format=tar.gz --output="${WORKDIR}/${TARNAME}.tar.gz" \
    --prefix="${TARNAME}/" master 2> /dev/null
cd "${WORKDIR}"

tar xf "${TARNAME}.tar.gz"
cp "${TARNAME}.tar.gz" "${NAME}_${VERSION}.orig.tar.gz"
cd "${TARNAME}"
cp -r "${SRCDIR}/packaging/debian" .

debuild --no-tgz-check -uc -us -b

cp "../${TARGET_NAME}_${VERSION}_${ARCHITECTURE}.deb" "${SRCDIR}"

rm -rf "${WORKDIR}"
